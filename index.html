<!DOCTYPE html>
<html>
<head>
  <title>Display GPS Location</title>
  <link rel="manifest" href="manifest.json">
</head>
<body>
  <h1>Current GPS Location</h1>
  <p id="location"></p>
  <table id="featureTable">
    <tr>
      <th>Distance (m)</th>
      <th>Name</th>
      <th>Type</th>
    </tr>
  </table>

  <script>
    function getLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(showPosition, showError);
      } else {
        document.getElementById("location").innerHTML = "Geolocation is not supported by this browser.";
      }
    }

    function showPosition(position) {
      const latitude = position.coords.latitude;
      const longitude = position.coords.longitude;
      document.getElementById("location").innerHTML = "Latitude: " + latitude + "<br>Longitude: " + longitude;
      getLocationFeatures(longitude, latitude)
    }

    function getLocationFeatures(longitude, latitude) {
      
      // Map query using https://docs.mapbox.com/playground/tilequery/
      const queryURL = `https://api.mapbox.com/v4/mapbox.mapbox-streets-v8/tilequery/${longitude},${latitude}.json?radius=1000&limit=30&dedupe&geometry=point&access_token=pk.eyJ1IjoicGxhbmVtYWQiLCJhIjoiemdYSVVLRSJ9.g3lbg_eN0kztmsfIPxa9MQ`
      
      fetch(queryURL)
        .then( resp => resp.json() )
        .then( data => {
          var features = data.features;

          var table = document.getElementById("featureTable");
      
          for (var i = 0; i < features.length; i++) {
            var name = features[i].properties.name || features[i].properties.house_num || "";
            var featureClass = (features[i].properties.layer || "") + '/' + (features[i].properties.tilequery.class || "") + '/' + (features[i].properties.tilequery.category_en || "");
            var distance = features[i].properties.tilequery.distance || "";
      
            var row = table.insertRow();
            var nameCell = row.insertCell();
            var classCell = row.insertCell();
            var distanceCell = row.insertCell();

            distanceCell.innerHTML = featureClass;
            nameCell.innerHTML = name;
            classCell.innerHTML = featureClass;
          }
        })
    }

    function showError(error) {
      switch (error.code) {
        case error.PERMISSION_DENIED:
          document.getElementById("location").innerHTML = "User denied the request for Geolocation.";
          break;
        case error.POSITION_UNAVAILABLE:
          document.getElementById("location").innerHTML = "Location information is unavailable.";
          break;
        case error.TIMEOUT:
          document.getElementById("location").innerHTML = "The request to get user location timed out.";
          break;
        case error.UNKNOWN_ERROR:
          document.getElementById("location").innerHTML = "An unknown error occurred.";
          break;
      }
    }

    // Get the initial location when the page loads
    getLocation();

    // Update the location every second (1000 milliseconds)
    setInterval(getLocation, 1000);
  </script>
</body>
</html>
